name: Deploy to DataMais

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: DataMaisWeb/package-lock.json
    
    - name: Build backend
      run: |
        cd DataMais
        dotnet restore
        dotnet build -c Release
        dotnet publish -c Release -o ../publish/api
    
    - name: Build frontend
      run: |
        cd DataMaisWeb
        # Tenta npm ci primeiro, se falhar usa npm install
        npm ci || npm install --legacy-peer-deps
        npm run build
    
    - name: Deploy to server via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        source: "publish/api/*"
        target: "/home/becape/datamais.api"
    
    - name: Prepare frontend for deploy
      run: |
        cd DataMaisWeb/dist
        tar -czf ../../frontend.tar.gz .
    
    - name: Deploy frontend via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        source: "frontend.tar.gz"
        target: "/tmp"
    
    - name: Extract frontend files
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm -rf /var/www/datamais/*
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S tar -xzf /tmp/frontend.tar.gz -C /var/www/datamais
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm /tmp/frontend.tar.gz
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/datamais
    
    - name: Copy service file via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        source: "DataMais/datamais.service"
        target: "/tmp"
    
    - name: Setup permissions and restart service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          # Verificar se o arquivo foi copiado
          if [ ! -f "/tmp/datamais.service" ]; then
            echo "❌ Arquivo datamais.service não encontrado em /tmp"
            exit 1
          fi
          
          # Descobrir onde dotnet está instalado
          DOTNET_PATH=""
          if [ -f "/home/becape/.dotnet/dotnet" ]; then
            DOTNET_PATH="/home/becape/.dotnet/dotnet"
          elif [ -f "/usr/share/dotnet/dotnet" ]; then
            DOTNET_PATH="/usr/share/dotnet/dotnet"
          elif [ -f "/opt/dotnet/dotnet" ]; then
            DOTNET_PATH="/opt/dotnet/dotnet"
          elif [ -f "/usr/local/bin/dotnet" ]; then
            DOTNET_PATH="/usr/local/bin/dotnet"
          elif [ -f "/usr/bin/dotnet" ]; then
            DOTNET_PATH="/usr/bin/dotnet"
          else
            # Tentar via PATH do usuário
            DOTNET_PATH=$(bash -c 'source ~/.profile 2>/dev/null || true; source ~/.bashrc 2>/dev/null || true; which dotnet 2>/dev/null || echo ""')
            if [ -z "$DOTNET_PATH" ]; then
              echo "⚠️  dotnet não encontrado. Verifique a instalação."
              DOTNET_PATH="dotnet"  # Usar PATH como fallback
            fi
          fi
          echo "✓ Usando dotnet em: $DOTNET_PATH"
          
          # Ajustar o arquivo de serviço com o caminho correto
          sed -i "s|ExecStart=.*|ExecStart=$DOTNET_PATH /home/becape/datamais.api/DataMais.dll|" /tmp/datamais.service
          
          # Usar sudo com senha via stdin
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S cp /tmp/datamais.service /etc/systemd/system/datamais.service
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R becape:becape /home/becape/datamais.api
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chmod +x /home/becape/datamais.api/DataMais || true
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/datamais
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl daemon-reload
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl restart datamais.service || true
