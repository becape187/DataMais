name: Deploy to DataMais

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: DataMaisWeb/package-lock.json
    
    - name: Build backend
      run: |
        cd DataMais
        dotnet restore
        dotnet build -c Release
        dotnet publish -c Release -o ../publish/api
    
    - name: Build frontend
      run: |
        cd DataMaisWeb
        npm ci
        npm run build
    
    - name: Deploy to server via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        source: "publish/api/*"
        target: "/home/becape/datamais.api"
    
    - name: Deploy frontend via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        source: "DataMaisWeb/dist/*"
        target: "/var/www/datamais"
    
    - name: Copy service file via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        source: "DataMais/datamais.service"
        target: "/tmp"
    
    - name: Setup permissions and restart service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          sudo cp /tmp/datamais.service /etc/systemd/system/datamais.service
          sudo chown -R becape:becape /home/becape/datamais.api
          sudo chmod +x /home/becape/datamais.api/DataMais || true
          sudo chown -R www-data:www-data /var/www/datamais
          sudo systemctl daemon-reload
          sudo systemctl restart datamais.service || true
