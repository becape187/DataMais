name: Deploy to DataMais

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: DataMaisWeb/package-lock.json
    
    - name: Build backend
      run: |
        cd DataMais
        dotnet restore
        dotnet build -c Release
        dotnet publish -c Release -o ../publish/api
    
    - name: Build frontend
      run: |
        cd DataMaisWeb
        # Tenta npm ci primeiro, se falhar usa npm install
        npm ci || npm install --legacy-peer-deps
        npm run build
    
    - name: Stop service before deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl stop datamais.service || true
          echo "âœ“ ServiÃ§o parado antes do deploy"
    
    - name: Prepare backend for deploy
      run: |
        cd publish/api
        tar -czf ../../backend.tar.gz .
    
    - name: Deploy backend via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        source: "backend.tar.gz"
        target: "/tmp"
    
    - name: Extract backend files
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm -rf /home/becape/datamais.api/*
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S tar -xzf /tmp/backend.tar.gz -C /home/becape/datamais.api
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm /tmp/backend.tar.gz
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R becape:becape /home/becape/datamais.api
          echo "âœ“ Arquivos do backend extraÃ­dos corretamente em /home/becape/datamais.api"
    
    - name: Prepare frontend for deploy
      run: |
        cd DataMaisWeb/dist
        tar -czf ../../frontend.tar.gz .
    
    - name: Deploy frontend via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        source: "frontend.tar.gz"
        target: "/tmp"
    
    - name: Extract frontend files
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm -rf /var/www/datamais/*
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S tar -xzf /tmp/frontend.tar.gz -C /var/www/datamais
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S rm /tmp/frontend.tar.gz
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/datamais
    
    - name: Setup permissions and restart service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          # Verificar se os arquivos foram copiados corretamente
          echo "ðŸ“¦ Verificando arquivos copiados..."
          if [ -f "/home/becape/datamais.api/DataMais.dll" ]; then
            echo "âœ“ DataMais.dll encontrado"
            ls -lh /home/becape/datamais.api/DataMais.dll
          else
            echo "âŒ ERRO: DataMais.dll NÃƒO encontrado em /home/becape/datamais.api/"
            echo "ConteÃºdo do diretÃ³rio:"
            ls -la /home/becape/datamais.api/ || echo "DiretÃ³rio nÃ£o existe"
            exit 1
          fi
          
          # Descobrir onde dotnet estÃ¡ instalado
          DOTNET_PATH=""
          if [ -f "/home/becape/.dotnet/dotnet" ]; then
            DOTNET_PATH="/home/becape/.dotnet/dotnet"
          elif [ -f "/usr/share/dotnet/dotnet" ]; then
            DOTNET_PATH="/usr/share/dotnet/dotnet"
          elif [ -f "/opt/dotnet/dotnet" ]; then
            DOTNET_PATH="/opt/dotnet/dotnet"
          elif [ -f "/usr/local/bin/dotnet" ]; then
            DOTNET_PATH="/usr/local/bin/dotnet"
          elif [ -f "/usr/bin/dotnet" ]; then
            DOTNET_PATH="/usr/bin/dotnet"
          else
            # Tentar via PATH do usuÃ¡rio
            DOTNET_PATH=$(bash -c 'source ~/.profile 2>/dev/null || true; source ~/.bashrc 2>/dev/null || true; which dotnet 2>/dev/null || echo ""')
            if [ -z "$DOTNET_PATH" ]; then
              echo "âš ï¸  dotnet nÃ£o encontrado. Verifique a instalaÃ§Ã£o."
              DOTNET_PATH="dotnet"  # Usar PATH como fallback
            fi
          fi
          echo "âœ“ Usando dotnet em: $DOTNET_PATH"
          
          # Criar arquivo de serviÃ§o diretamente
          cat > /tmp/datamais.service << EOFSERVICE
          [Unit]
          Description=DataMais API Service
          After=network.target postgresql.service influxdb.service

          [Service]
          Type=simple
          User=becape
          Group=becape
          WorkingDirectory=/home/becape/datamais.api
          ExecStart=$DOTNET_PATH /home/becape/datamais.api/DataMais.dll
          Restart=always
          RestartSec=10
          KillSignal=SIGINT
          SyslogIdentifier=datamais
          Environment=ASPNETCORE_ENVIRONMENT=Production
          Environment=ASPNETCORE_URLS=http://0.0.0.0:5000
          Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
          EnvironmentFile=/home/becape/datamais.env
          TimeoutStartSec=30

          # Security
          NoNewPrivileges=true
          PrivateTmp=true
          ProtectSystem=strict
          ReadWritePaths=/home/becape/datamais.api
          ReadOnlyPaths=/home/becape/datamais.env

          [Install]
          WantedBy=multi-user.target
          EOFSERVICE
          
          echo "âœ“ Arquivo de serviÃ§o criado em /tmp/datamais.service"
          
          # Usar sudo com senha via stdin
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S cp /tmp/datamais.service /etc/systemd/system/datamais.service
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R becape:becape /home/becape/datamais.api
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chmod +x /home/becape/datamais.api/DataMais || true
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/datamais
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl daemon-reload
          echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl restart datamais.service || true
          
          # Verificar se o serviÃ§o iniciou corretamente
          sleep 2
          if systemctl is-active --quiet datamais.service; then
            echo "âœ“ ServiÃ§o iniciado com sucesso"
          else
            echo "âŒ ERRO: ServiÃ§o nÃ£o iniciou. Verificar logs:"
            sudo journalctl -u datamais.service -n 20 --no-pager
            exit 1
          fi